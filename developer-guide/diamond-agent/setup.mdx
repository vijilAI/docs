---
title: 'Setup & Configuration'
description: 'Install and configure the Diamond ADK agent for local and production use.'
---

This guide covers installation, configuration options, and programmatic usage of the Diamond ADK agent.

## Installation

### From Source

```bash
git clone https://github.com/vijilAI/vijil-diamond.git
cd vijil-diamond
pip install -e ".[adk]"
```

### From PyPI (when published)

```bash
pip install vijil-diamond[adk]
```

### Dependencies

The `[adk]` extra installs:
- `google-adk[a2a]>=1.20.0` - Google Agent Development Kit with A2A support

Core Diamond dependencies (always installed):
- `httpx` - Async HTTP client
- `pydantic` - Data validation
- `numpy` - Numerical operations
- `openai` - LLM client (for detectors)

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GOOGLE_API_KEY` | - | Google/Gemini API key (required for default model) |
| `DIAMOND_MODEL_PROVIDER` | `google` | LLM provider: `google`, `anthropic`, `openai` |
| `DIAMOND_MODEL_ID` | `gemini-2.0-flash` | Model identifier |
| `DIAMOND_PORT` | `8080` | A2A server port |
| `DIAMOND_HOST` | `0.0.0.0` | Server bind address |
| `DIAMOND_RESOURCE_DIR` | `resources` | Path to harness resources |
| `DIAMOND_MAX_PROBES` | `100` | Default max probes per evaluation |
| `DIAMOND_STORAGE_PROVIDER` | `filesystem` | Storage backend: `filesystem`, `aws`, `gcp`, `digitalocean` |
| `DIAMOND_STORAGE_BUCKET` | - | S3/GCS bucket name (required for cloud storage) |
| `DIAMOND_STORAGE_PATH` | `~/.diamond/storage` | Base path for filesystem storage |
| `DIAMOND_STORAGE_REGION` | - | AWS/DigitalOcean region (required for aws/digitalocean) |

### Command Line Options

```bash
python -m diamond.adk [OPTIONS]

Options:
  --port INT        Port to run server on (default: 8080)
  --host TEXT       Host to bind to (default: 0.0.0.0)
  --model TEXT      Model ID for agent reasoning (default: gemini-2.0-flash)
  --resources TEXT  Path to resources directory (default: resources)
```

### Using Different LLM Providers

<Tabs>
  <Tab title="Google Gemini (Default)">
    ```bash
    export GOOGLE_API_KEY="your-key"
    python -m diamond.adk --model gemini-2.0-flash
    ```
  </Tab>
  <Tab title="OpenAI">
    ```bash
    export OPENAI_API_KEY="your-key"
    python -m diamond.adk --model gpt-4o
    ```

    <Note>
    Requires `openai` package installed separately if not using Gemini.
    </Note>
  </Tab>
  <Tab title="Anthropic Claude">
    ```bash
    export ANTHROPIC_API_KEY="your-key"
    python -m diamond.adk --model claude-3-sonnet
    ```

    <Note>
    Requires `anthropic` package installed separately.
    </Note>
  </Tab>
</Tabs>

## Programmatic Usage

### Creating a Diamond Agent

```python
from diamond.adk import DiamondConfig, create_diamond_agent

# Create configuration
config = DiamondConfig(
    model_id="gemini-2.0-flash",
    resource_dir="resources",
    default_max_probes=50,
)

# Create the agent
agent = create_diamond_agent(config)
```

### Creating an A2A Server

```python
from diamond.adk import DiamondConfig, create_a2a_app
import uvicorn

# Create configuration
config = DiamondConfig(
    server_port=8080,
    model_id="gemini-2.0-flash",
)

# Create the A2A application
app = create_a2a_app(config)

# Run with uvicorn
uvicorn.run(app, host="0.0.0.0", port=8080)
```

### Using as a Library

```python
from diamond.adk.tools import evaluate, list_probes, get_agent_info, set_config
from diamond.adk.config import DiamondConfig
import asyncio

# Configure tools
config = DiamondConfig(resource_dir="resources")
set_config(config)

async def main():
    # List available harnesses
    harnesses = await list_probes()
    print(harnesses)

    # Get info about a target agent
    info = await get_agent_info("http://localhost:9000")
    print(info)

    # Run an evaluation
    result = await evaluate(
        target_agent_url="http://localhost:9000",
        harness_id="vijil.harnesses.security",
        max_probes=10
    )
    print(result)

asyncio.run(main())
```

## DiamondConfig Reference

```python
from dataclasses import dataclass
from typing import Literal, Optional

@dataclass
class DiamondConfig:
    # LLM Configuration
    model_provider: Literal["google", "anthropic", "openai"] = "google"
    model_id: str = "gemini-2.0-flash"

    # Resource Configuration
    resource_dir: str = "resources"
    default_max_probes: int = 100

    # Server Configuration
    server_host: str = "0.0.0.0"
    server_port: int = 8080

    # Timeout Configuration
    agent_timeout: float = 300.0      # Target agent request timeout
    detection_timeout: float = 60.0   # Detector request timeout

    # Storage Configuration
    storage_provider: Literal["filesystem", "aws", "gcp", "digitalocean"] = "filesystem"
    storage_bucket: Optional[str] = None   # Required for cloud storage
    storage_path: Optional[str] = None     # Base path for filesystem
    storage_region: Optional[str] = None   # Required for AWS/DigitalOcean

    @classmethod
    def from_env(cls) -> "DiamondConfig":
        """Create config from environment variables."""
        ...
```

## Result Storage

Diamond persists evaluation results to storage for later retrieval. By default, results are stored locally in `~/.diamond/storage/`.

### Storage Structure

```
~/.diamond/storage/
└── evaluations/
    ├── eval-abc123/
    │   └── results.json
    ├── eval-def456/
    │   └── results.json
    └── ...
```

### Configuring Storage Backends

<Tabs>
  <Tab title="Filesystem (Default)">
    No configuration needed for local development:
    ```bash
    # Results stored at ~/.diamond/storage/evaluations/
    python -m diamond.adk
    ```

    Custom path:
    ```bash
    export DIAMOND_STORAGE_PATH=/data/diamond
    python -m diamond.adk
    ```
  </Tab>
  <Tab title="AWS S3">
    ```bash
    export DIAMOND_STORAGE_PROVIDER=aws
    export DIAMOND_STORAGE_BUCKET=my-diamond-bucket
    export DIAMOND_STORAGE_REGION=us-west-2
    export AWS_ACCESS_KEY_ID=your-key
    export AWS_SECRET_ACCESS_KEY=your-secret
    python -m diamond.adk
    ```

    <Note>
    AWS credentials can also be provided via IAM roles (IRSA in EKS) or `~/.aws/credentials`.
    </Note>
  </Tab>
  <Tab title="Google Cloud Storage">
    ```bash
    export DIAMOND_STORAGE_PROVIDER=gcp
    export DIAMOND_STORAGE_BUCKET=my-diamond-bucket
    export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json
    python -m diamond.adk
    ```
  </Tab>
  <Tab title="DigitalOcean Spaces">
    ```bash
    export DIAMOND_STORAGE_PROVIDER=digitalocean
    export DIAMOND_STORAGE_BUCKET=my-space
    export DIAMOND_STORAGE_REGION=nyc3
    export DO_ACCESS_KEY_ID=your-key
    export DO_SECRET_ACCESS_KEY=your-secret
    python -m diamond.adk
    ```
  </Tab>
</Tabs>

### Retrieving Stored Results

```python
from diamond.adk.tools import get_evaluation_result, list_evaluations

# List all stored evaluations
evaluation_ids = await list_evaluations()
print(evaluation_ids)  # ['eval-abc123', 'eval-def456', ...]

# Retrieve a specific result
result = await get_evaluation_result("eval-abc123")
print(result["trust_score"])  # 85.0
```

## Resource Directory Structure

The `resources/` directory contains harness configurations:

```
resources/
├── harness_configs/
│   └── harness/
│       ├── vijil.harnesses.security.yaml
│       ├── vijil.harnesses.safety.yaml
│       ├── vijil.harnesses.reliability.yaml
│       ├── vijil.harnesses.fairness.yaml
│       └── vijil.harnesses.privacy.yaml
├── detector_configs/
│   └── ...
└── garak_resources/
    └── ...
```

<Warning>
The harness resources must be present for evaluations to run. If you see "harness not found" errors, ensure the resources are downloaded and the `resource_dir` path is correct.
</Warning>

## Running with Docker

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY . .
RUN pip install -e ".[adk]"

# Copy resources
COPY resources/ /app/resources/

ENV GOOGLE_API_KEY=""
ENV DIAMOND_RESOURCE_DIR=/app/resources

EXPOSE 8080
CMD ["python", "-m", "diamond.adk", "--port", "8080"]
```

Build and run:

```bash
docker build -t diamond-agent .
docker run -p 8080:8080 -e GOOGLE_API_KEY=$GOOGLE_API_KEY diamond-agent
```

## Health Checks

Diamond exposes standard A2A endpoints:

| Endpoint | Description |
|----------|-------------|
| `/.well-known/agent.json` | Agent card (capabilities) |
| `/.well-known/agent-card.json` | Agent card (alternate) |
| `/` | JSON-RPC endpoint |

Health check example:

```bash
curl -s http://localhost:8080/.well-known/agent.json | jq '.name'
# Output: "Diamond"
```

## Production Integration via Vijil Console

For production use, you can evaluate A2A agents through Vijil Console instead of running Diamond ADK locally. This provides:

- Centralized evaluation management
- Team-based access control
- Persistent result storage
- Integration with CI/CD pipelines

### Registering an A2A Agent

When registering an agent in Vijil Console, set the `hub` field to `"a2a"` to enable A2A protocol communication:

<Tabs>
  <Tab title="Console UI">
    1. Navigate to **Agents** → **Register Agent**
    2. Set **Hub** to `A2A Protocol`
    3. Enter the agent's A2A endpoint URL (e.g., `http://my-agent:9000`)
    4. Save the agent configuration
  </Tab>
  <Tab title="API">
    ```bash
    curl -X POST https://api.vijil.ai/agents \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d '{
        "agent_name": "My A2A Agent",
        "hub": "a2a",
        "agent_url": "http://my-agent:9000",
        "model_name": "my-model"
      }'
    ```
  </Tab>
</Tabs>

### Hub-Based Provider Routing

Diamond automatically selects the appropriate communication protocol based on the agent's `hub` setting:

| Hub Value | Provider | Protocol |
|-----------|----------|----------|
| `a2a` | A2AAgentProvider | A2A JSON-RPC |
| `openai` (default) | ChatCompletionsAgentProvider | OpenAI-compatible |
| `groq` | ChatCompletionsAgentProvider | OpenAI-compatible |
| `anthropic` | ChatCompletionsAgentProvider | OpenAI-compatible |

### Running A2A Evaluations

Once registered, evaluate the A2A agent like any other:

```bash
curl -X POST https://api.vijil.ai/evaluations \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "your-agent-uuid",
    "harness_names": ["security", "safety"]
  }'
```

Diamond will automatically use the A2A protocol to communicate with your agent.

<Note>
A2A agents must expose an agent card at `/.well-known/agent.json` and accept JSON-RPC messages at `POST /`.
</Note>

## Next Steps

<CardGroup cols={2}>
  <Card title="API Reference" icon="book" href="/developer-guide/diamond-agent/api-reference">
    Complete API documentation
  </Card>
  <Card title="Evaluate A2A Agents" icon="play" href="/tutorials/diamond-agent/evaluate-a2a-agents">
    Tutorial: Run your first evaluation
  </Card>
</CardGroup>
